<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Lens Selector (Geometry & Fitting V12)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --green:#0b3d2e;
    --pale:#ffffe0;
    --off:#f8f8f5;
    --line:#d7d7cf;
    --warn:#B42318;
    --barOD:#b0a2d9;
    --barOS:#d0c9eb;
    --frame:#a9a9a9;
    --btn-bg:#0b3d2e;
    --btn-text:#ffffe0;
    --btn-border:#ffffff;
  }



  html,body{
    background:var(--off);
    color:var(--green);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    font-size:12px;
    line-height:1.35;
    margin:0;
  }
  h1{font-size:13px;text-align:center;margin:12px 0 10px;}
  h3{font-size:12px;margin:0 0 8px;}
  .wrap{width:90%;max-width:900px;margin:0 auto;padding:5px;}
  .section{background:var(--pale);border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;}
  table{width:100%;border-collapse:collapse;}
  th,td{border:1px solid var(--line);padding:5px 3px;text-align:center; height:30px}
  th{background:#e8e8dd;}

  /* Inputs */
  input[type="text"], input[type="number"]{
    width:90px;font-size:12px;padding:3px 3px;border:1px solid #c9c9c1;border-radius:6px;
    text-align:center;background:#fff;color:var(--green);
  }
  label{font-weight:600}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{display:flex;flex-direction:column;gap:4px}
  .field.w90{width:90px}
  .tiny{font-size:12px;opacity:1}
  .muted{opacity:1}

  /* Buttons with white inner border */
  button{
    background:var(--btn-bg);
    color:var(--btn-text);
    border:1px solid var(--btn-border);
    padding:5px 15px;
    border-radius:7px;
    cursor:pointer;
    font-size:12px;
    font-weight:700;
  }
  button:focus{outline:1px solid #fff4; outline-offset:1px;}
  button:hover{filter:brightness(1.05);}
  button:active{transform:translateY(1px);}

  /* Pane boxes (white interior) */
  .pane{
    background:#fff;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
  }
  .pane h4{margin:0 0 8px;font-size:12px}

  /* Bars */
  .bar-row{display:flex;align-items:flex-start;gap:10px;margin:6px 0;flex-wrap:wrap}
  .bar-label{width:40px;text-align:right;font-weight:bold}
  .bar-pair{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap} /* visual gap between OD & OS */
  .bar-block{display:flex;flex-direction:column;gap:3px;min-width:220px}
  .bar{height:12px;border-radius:2px}
  .bar-frame{height:6px;border-radius:2px;background:var(--frame)}
  .bar-text{font-size:12px;opacity:1}

  /* Filters inside panes */
  .filters{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 2px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:12px;background:#fff}

  @media(max-width:640px){
    input[type="text"],input[type="number"]{width:70px}
    .row{flex-direction:column;align-items:flex-start}
    .bar-block{min-width:180px}
  }
</style>
</head>
<body>

<div class="wrap">
  <h1>Lens Selector (Geometry & Fitting)</h1>

  <!-- Prescription + Frame -->
  <div class="section">
    <h3>Prescription & Frame Details</h3>
    <table>
      <thead><tr><th>Eye</th><th>Sph</th><th>Cyl</th><th>Axis</th></tr></thead>
      <tbody>
        <tr>
          <td><b>Right Eye</b></td>
          <!-- text inputs so + sign is preserved -->
          <td><input type="text" id="sphOD" placeholder="e.g. -3.25"></td>
          <td><input type="text" id="cylOD" placeholder="e.g. -1.25"></td>
          <td><input type="number" id="axisOD" step="1" placeholder="e.g. 180"></td>
        </tr>
        <tr>
          <td><b>Left Eye</b></td>
          <td><input type="text" id="sphOS" placeholder="e.g. +2.00"></td>
          <td><input type="text" id="cylOS" placeholder="e.g. -0.75"></td>
          <td><input type="number" id="axisOS" step="1" placeholder="e.g. 90"></td>
        </tr>
<tr>
<td><b>Quick Fill Both Eye</b></td>
<td colspan="3">
<div class="quickRow"><b>SPH :</b>
  <button class="quickBtn" onclick="bumpSphOU(+2)">+2.00 </button>
  <button class="quickBtn" onclick="bumpSphOU(-2)">-2.00 </button>
  <button class="quickBtn" onclick="bumpSphOU(+0.50)">+0.50 </button>
  <button class="quickBtn" onclick="bumpSphOU(-0.50)">-0.50 </button>
</div>
</td>
</tr>
      </tbody>

    </table>



    <div class="row" style="margin-top:12px; gap:20px;">
      <div class="field w90"><label for="frameA">Frame Size (A)</label><input id="frameA" type="number" placeholder="e.g. 52"></div>
      <div class="field w90"><label for="frameDBL">Bridge (DBL)</label><input id="frameDBL" type="number" placeholder="e.g. 17"></div>
      <div class="field w90"><label for="monoPD_OD">Right PD</label><input id="monoPD_OD" type="number" placeholder="e.g. 31"></div>
      <div class="field w90"><label for="monoPD_OS">Left PD</label><input id="monoPD_OS" type="number" placeholder="e.g. 32"></div>
      <div class="field w90" style="display:none;"><label for="safety">Safety</label><input id="safety" type="number" placeholder="2" value="2"></div>
    </div>

  <!-- Stacked panes: 1) Thickness calc, 2) Price cap, 3) Fetch -->
    <!-- 1: Thickness Calculation -->
      <div class="row" style="margin:10px 0px; gap:10px;"> <label>Calculate Lens Size</label>
        <button id="btnCalc">By RX Details </button> /  
   
          <label for="lengthInput" style="Display:none;">Length (mm)</label>
          <input id="lengthInput" type="number" value="30" step="1" style="width:40px;"> mm</b>
        <button id="btnLength" style="background-color:lightsalmon; color:black">By Manual</button>

      </div>

  


<div id="MBS" style="display:;">

  <!-- Thickness -->

    <div id="thicknessBars" style="margin-top:10px; display:none"></div>
    <div id="thickNote" class="tiny muted" style="margin-top:4px; display:none"></div>
    <div id="mbsLine" class="tiny"></div>
  </div>
 <button style="display:none" onclick="toggleDiv('MBS')">Show Minimum Blank Size & Thickness </button>

</div>

  <div class="section">


  <!-- Lens Options with Filters in white panes -->
    <h3>Lens Options</h3>

<div class="pane" style="margin:10px 0px 10px 0px; display:none">
      <h4>Price (RM)</h4>
      <div class="row" style="gap:8px;align-items:center;">
        Max Price <input id="priceCap" type="number" placeholder="e.g. 1000" style="width:110px;">
        <button id="capMinus">‚Äì RM100</button>
        <button id="capPlus">+ RM100</button>
</div>
</div>

    <div class="pane" style="margin:10px 0;">
      <h4>Appearance</h4>
      <div class="filters">
        <label class="chip"><input type="checkbox" class="fl-appear" value="Clear" > Clear</label>
        <label class="chip"><input type="checkbox" class="fl-appear" value="Photochromic" > Photochromic</label>
        <label class="chip"><input type="checkbox" class="fl-appear" value="Tinted" > Tinted</label>
        <label class="chip"><input type="checkbox" class="fl-appear" value="Polarized" > Polarized</label>
      </div>
    </div>

    <div class="pane" style="margin-bottom:10px;">
      <h4>Lens Material</h4>
      <div class="filters">
        <label class="chip"><input type="checkbox" class="fl-index" value="1.5" >Normal</label>
        <label class="chip"><input type="checkbox" class="fl-index" value="1.6">Thinner</label>
        <label class="chip"><input type="checkbox" class="fl-index" value="1.67" > Extra Thin</label>
        <label class="chip"><input type="checkbox" class="fl-index" value="1.74">Most Thin</label>
        <label class="chip"><input type="checkbox" class="fl-index" value="Safety" > Safety Material</label>
      </div>
    </div>

    <div class="pane" style="margin-bottom:10px;">
      <h4>Function</h4>
      <div class="filters">
        <label class="chip"><input type="checkbox" class="fl-func" value="SV" > Single Vision</label>
        <label class="chip"><input type="checkbox" class="fl-func" value="Multifocal" > Multifocal</label>
        <label class="chip"><input type="checkbox" class="fl-func" value="Office" > Office</label>
        <label class="chip"><input type="checkbox" class="fl-func" value="Anti-fatigue" > Anti-Fatigue</label>
<label class="chip"><input type="checkbox" class="fl-func" value="Myopia Control" > Myopia Control</label>

      </div>

   </div>

<div class="pane" style="margin-bottom:10px;">
  <h4>Lens Performance</h4>
  <div class="filters">
    <label class="chip"><input type="checkbox" class="fl-perf" value="Basic Economical"> Basic Economical</label>
    <label class="chip"><input type="checkbox" class="fl-perf" value="Premium Economical"> Premium Economical</label>
    <label class="chip"><input type="checkbox" class="fl-perf" value="Premium Custom"> Premium Custom</label>
    <label class="chip"><input type="checkbox" class="fl-perf" value="Luxury Custom"> Luxury Custom</label>
  </div>
</div>






 <button style="background-color:lightsalmon; color:black"id="btnFetch">Search Lenses</button>
    <span id="status" class="tiny muted"></span>
    <button id="btnClearFilters">Clear All Filters</button>

    <table id="resultsTable" style="margin-top:8px;">
      <thead>
        <tr>
          <th>Product</th>
	  <th>Lens Type</th>
          <th>Blue-Reduce<br>Coating</th>
          <th>Premium<br>Coating</th>
          <th>Lens Size</th>
        </tr>
      </thead>
      <tbody id="resultsBody">
        <tr><td colspan="6" class="muted">Calculate Lens Size first, then click ‚ÄúSearch Lenses‚Äù.</td></tr>
      </tbody>
    </table>
  </div>
</div>






















<script>
/* =========================
   CONFIG
========================= */
const CSV_URL = "https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/lens%20selector.csv";
const INDICES = [1.56, 1.60, 1.67, 1.74];
const CENTER_MINUS = 1.3;   // minus lens min center thickness
const EDGE_PLUS    = 1.3;   // plus lens min center thickness
const BASE_PX      = 50 * 0.6; // px per mm before scale radios

function minusCorr(n){ if(n===1.56) return 1.075; if(n===1.60) return 1.025; return 1; }
function plusCorr(n){  if(n===1.56) return 1.10;  if(n===1.60) return 1.05;  if(n===1.67) return 1.025; if(n===1.74) return 1.0125; return 1; }

/* =========================
   STATE
========================= */
let PRODUCTS = [];
let LAST_GEOM = null;   // {semiOD, semiOS, MBS}
let LAST_MODE = null;   // "frame" | "length"

/* =========================
   INPUT ROUNDING (text inputs keep + sign)
========================= */
function parseToNumber(str){
  if(!str) return 0;
  const v = parseFloat(String(str).replace(/\s+/g,'').replace('+',''));
  return isNaN(v) ? 0 : v;
}
function round025number(x){
  const s = x >= 0 ? 1 : -1;
  const a = Math.abs(x);
  const r = Math.round(a / 0.25) * 0.25;
  return s * r;
}
function formatSigned025(x){
  const v = round025number(x);
  return (v > 0 ? "+" : "") + v.toFixed(2);
}
function onSignedBlur(el){
  const v = parseToNumber(el.value);
  el.value = formatSigned025(v);
}
function roundAxis(el){
  let v = parseFloat(el.value);
  if(isNaN(v)) return;
  v = Math.round(v);
  if(v < 0) v += 180;
  if(v > 180) v = v % 180;
  el.value = v;
}
document.addEventListener("DOMContentLoaded", ()=>{
  ['sphOD','cylOD','sphOS','cylOS'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('blur', ()=> onSignedBlur(el));
  });
  ['axisOD','axisOS'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('blur', ()=> roundAxis(el));
  });
});

/* =========================
   OPTICS
========================= */
function effectivePower(S,C,axisDeg){
  const a = ((axisDeg % 180) + 180) % 180;
  const s = Math.sin(a * Math.PI / 180);
  return S + C * s * s; // horizontal meridian power
}
function minusThickness(S,C,A,n,y){
  const Fh = Math.abs(effectivePower(S,C,A));
  let t = CENTER_MINUS + (y*y*Fh)/(2000*(n-1));
  t *= minusCorr(n);
  return t;
}
function plusThickness(S,C,A,n,y){
  const Fh = effectivePower(S,C,A);
  let t = EDGE_PLUS + (y*y*Fh)/(2000*(n-1)); // center thickness from rim sag
  t = Math.max(t, 1.3);
  t *= plusCorr(n);
  return t;
}

/* =========================
   GEOMETRY
========================= */
function computeSemi(A, DBL, monoPD, safety=2){
  const framePDhalf = (A + DBL) / 2;
  const dec = Math.abs(framePDhalf - monoPD);
  return (A/2) + dec + safety;
}
function computeMBS(A, DBL, pdOD, pdOS, safety=2){
  const semiOD = computeSemi(A, DBL, pdOD, safety);
  const semiOS = computeSemi(A, DBL, pdOS, safety);
  return { semiOD, semiOS, MBS: 2 * Math.max(semiOD, semiOS) };
}

/* =========================
   HELPERS
========================= */
function getVal(id){ return parseFloat(document.getElementById(id)?.value) || 0; }
function parseRx(){
  const SOD = parseToNumber(document.getElementById("sphOD")?.value);
  const COD = parseToNumber(document.getElementById("cylOD")?.value);
  const SOS = parseToNumber(document.getElementById("sphOS")?.value);
  const COS = parseToNumber(document.getElementById("cylOS")?.value);
  return {
    OD:{ S:SOD, C:COD, Ax:getVal("axisOD") },
    OS:{ S:SOS, C:COS, Ax:getVal("axisOS") }
  };
}

/* =========================
   CSV LOADING (DOM-safe)
========================= */
async function loadCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
  const headers = rows[0].map(h => h.replace(/^"|"$/g,'').trim());
  return rows.slice(1).map(r=>{
    const obj={};
    r.forEach((val,i)=> obj[headers[i]] = (val||"").replace(/^"|"$/g,'').trim() );
    return obj;
  });
}
async function init(){
  const statusEl = document.getElementById("status");
  if(statusEl) statusEl.textContent = "Loading CSV‚Ä¶";
  try{
    PRODUCTS = await loadCSV(CSV_URL);
    if(statusEl) statusEl.textContent = ""; // blank on success
  }catch(e){
    if(statusEl) statusEl.textContent = "CSV load failed.";
    console.error("CSV load error:", e);
  }
}
document.addEventListener("DOMContentLoaded", init);

/* =========================
   FILTER GROUPING HELPERS
========================= */
function getAppearance(val=""){
  const s = val.toLowerCase();
  if(s.includes("polar")) return "Polarized";
  if(s.includes("tint"))  return "Tinted";
  if(s.includes("chang") || s.includes("photo")) return "Photochromic";
  return "Clear";
}
function getIndexGroup(val=""){
  const n = parseFloat(val)||0;
  if(n===1.53 || n===1.59) return "Safety";
  if(n>=1.49 && n<1.59)    return "1.5";
  if(n>=1.59 && n<1.65)    return "1.6";
  if(n>=1.65 && n<1.71)    return "1.67";
  if(n>=1.73 && n<1.76)    return "1.74";
  if(Math.abs(n-1.67)<0.02) return "1.67";
  if(Math.abs(n-1.60)<0.02) return "1.6";
  if(Math.abs(n-1.74)<0.02) return "1.74";
  return "1.5";
}
function getFunctionCat(val = "") {
  const s = val.toLowerCase();

  // --- Myopia Control ---
  if (
    s.includes("myopia control") ||
    s.includes("mc") ||
    s.includes("control")
  ) {
    return "Myopia Control";
  }

  // --- Multifocal ---
  if (
    s.includes("pal") ||
    s.includes("progress") ||
    s.includes("progressive") ||
    s.includes("multifocal") ||
    s.includes("bifocal")
  ) {
    return "Multifocal";
  }

  // --- Office ---
  if (
    s.includes("office") ||
    s.includes("room") ||
    s.includes("workspace") ||
    s.includes("near variable") ||
    s.includes("nvf") ||
    s.includes("computer")
  ) {
    return "Office";
  }

  // --- Anti-fatigue ---
  if (
    s.includes("anti-fatigue") ||
    s.includes("antifatigue") ||
    s.includes("relax") ||
    s.includes("boost") ||
    s.includes("af")
  ) {
    return "Anti-fatigue";
  }

  return "SV";
}

function checkedValues(selector){
  return Array.from(document.querySelectorAll(selector)).filter(i=>i.checked).map(i=>i.value);
}

/* =========================
   RESULTS TABLE
========================= */
function withinCap(price, cap){ if(!cap) return true; return Number(price) <= cap * 1.10; } // buffer kept silently


function buildResults(geom, rx){
  const body = document.getElementById("resultsBody");
  body.innerHTML = "";

  if(!geom){
    body.innerHTML = `<tr><td colspan="6" class="muted" style="color:var(--warn);font-weight:700;">Calculate Lens Size first, then click ‚ÄúSearch Lenses‚Äù.</td></tr>`;
    return;
  }

  const appearSet = checkedValues(".fl-appear");
  const indexSet  = checkedValues(".fl-index");
  const funcSet   = checkedValues(".fl-func");

  // üö® RULE: Each group MUST have ‚â•1 checked
  if (appearSet.length === 0 || indexSet.length === 0 || funcSet.length === 0) {
    body.innerHTML = `
      <tr><td colspan="6" class="muted" style="color:var(--warn);font-weight:700;">
        Please select at least one filter in every group.
      </td></tr>`;
    return;
  }

  const cap = parseFloat(document.getElementById("priceCap").value)||0;
  const FhOD = effectivePower(rx.OD.S, rx.OD.C, rx.OD.Ax);

  let count = 0;
  PRODUCTS.forEach(row=>{
    const price = parseFloat(row["UV_420_BL_PRICE_RM"]||"0");
    if(!withinCap(price, cap)) return;

    const app = getAppearance(row["CLEAR_CHANGING_TINT"]||"");
    const idxGroup = getIndexGroup(row["INDEX"]||"");
    const func = getFunctionCat(row["LENS_DESIGN"]||"");
// Convert short codes to full words
let funcDisplay = func;
if (func === "SV") funcDisplay = "Single Vision";


    // strict filter matching
    if(!appearSet.includes(app)) return;
    if(!indexSet.includes(idxGroup)) return;
    if(!funcSet.includes(func)) return;

    const dia = parseFloat(row["DIA"]||"0");
    let stockMsg = "Ok";

    if(dia < geom.MBS){
      stockMsg = `<span style="color:var(--warn);font-weight:700;">‚ö† Cannot fit</span>`;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row["PRODUCT_NAME"]||""}</td>
      <td>${row["INDEX"]||""}  ${app}  ${funcDisplay}</td>


<td>${fmtRM(price)}</td>
<td>${
  row["HIGH_CLARITY_COATING_PRICE_RM"] &&
  !isNaN(parseFloat(row["HIGH_CLARITY_COATING_PRICE_RM"]))
    ? fmtRM(row["HIGH_CLARITY_COATING_PRICE_RM"])
    : "‚Äî"
}</td>




      <td>${stockMsg}</td>
    `;
    body.appendChild(tr);
    count++;
  });

  if(!count){
    body.innerHTML = `<tr><td colspan="6" class="muted">No items match filters or price cap.</td></tr>`;
  }
}










/* =========================
   BARS / THICKNESS
========================= */
function renderBars(rx, geom, mode, lenOverride){
  const container = document.getElementById("thicknessBars");
  container.innerHTML = `
    <div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <label>Frame Thickness (mm):
        <input type="number" id="frameThickness" value="3.5" step="0.5" style="width:45px;">
      </label>
      <span style="font-weight:600;">------- &nbsp;&nbsp;&nbspChange Bar Scale:</span>
      <label><input type="radio" name="barScale" value="1"> 100%</label>
      <label><input type="radio" name="barScale" value="0.66" checked> 66%</label>
      <label><input type="radio" name="barScale" value="0.33"> 33%</label>
    </div>
  `;

  const frameInput = container.querySelector("#frameThickness");
  let scale = 0.66;

  container.querySelectorAll('input[name="barScale"]').forEach(r=>{
    r.addEventListener("change", ()=>{ scale=parseFloat(r.value); draw(); });
  });
  frameInput.addEventListener("input", ()=>draw());

  function eyeLabel(isPlus){ return isPlus ? "(center)" : "(edge)"; }

  function draw(){
    container.querySelectorAll(".bar-row").forEach(e=>e.remove());
    const frameT = parseFloat(frameInput.value)||0;

    INDICES.forEach(n=>{
      const yOD = (mode==="length") ? lenOverride : geom.semiOD;
      const yOS = (mode==="length") ? lenOverride : geom.semiOS;

      const FhOD = effectivePower(rx.OD.S,rx.OD.C,rx.OD.Ax);
      const FhOS = effectivePower(rx.OS.S,rx.OS.C,rx.OS.Ax);
      const isPlusOD = FhOD >= 0;
      const isPlusOS = FhOS >= 0;

      const tOD = isPlusOD ? plusThickness(rx.OD.S,rx.OD.C,rx.OD.Ax,n,yOD)
                           : minusThickness(rx.OD.S,rx.OD.C,rx.OD.Ax,n,yOD);
      const tOS = isPlusOS ? plusThickness(rx.OS.S,rx.OS.C,rx.OS.Ax,n,yOS)
                           : minusThickness(rx.OS.S,rx.OS.C,rx.OS.Ax,n,yOS);

      const px = BASE_PX * scale;
      const odLen = tOD * px, osLen = tOS * px, frameLen = frameT * px;

      const row = document.createElement("div");
      row.className = "bar-row";
      row.innerHTML = `
        <div class="bar-label">${n.toFixed(2)}</div>
        <div class="bar-pair">
          <div class="bar-block">
            <div class="bar" style="background:var(--barOD);width:${odLen}px;"></div>
            <div class="bar-frame" style="width:${frameLen}px;"></div>
            <div class="bar-text">Right Lens ${tOD.toFixed(1)} mm ${eyeLabel(isPlusOD)}</div>
          </div>
          <div class="bar-block">
            <div class="bar" style="background:var(--barOS);width:${osLen}px;"></div>
            <div class="bar-frame" style="width:${frameLen}px;"></div>
            <div class="bar-text">Left Lens ${tOS.toFixed(1)} mm ${eyeLabel(isPlusOS)}</div>
          </div>
        </div>
      `;
      container.appendChild(row);
    });

    // concise note
const note = [];
const odStatus = effectivePower(rx.OD.S, rx.OD.C, rx.OD.Ax) >= 0
  ? "center thickness (plus)"
  : "edge thickness (minus)";
const osStatus = effectivePower(rx.OS.S, rx.OS.C, rx.OS.Ax) >= 0
  ? "center thickness (plus)"
  : "edge thickness (minus)";

note.push(`Right Lens shows <strong>${odStatus}</strong>`);
note.push(`Left Lens shows <strong>${osStatus}</strong>`);

document.getElementById("thickNote").innerHTML = note.join(" &nbsp;‚Ä¢&nbsp; ");

  }
  draw();
}

/* =========================
   BUTTONS & FLOW
========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  // Price cap adjusters
  document.getElementById("capPlus").onclick=()=>{const e=document.getElementById("priceCap");e.value=(parseFloat(e.value)||0)+100;};
  document.getElementById("capMinus").onclick=()=>{const e=document.getElementById("priceCap");e.value=Math.max(0,(parseFloat(e.value)||0)-100);};

  // Calculate by Frame ‚Äî thickness only
  document.getElementById("btnCalc").onclick=()=>{
    const rx = parseRx();
    const A = getVal("frameA"), DBL = getVal("frameDBL");
    const pdOD = getVal("monoPD_OD"), pdOS = getVal("monoPD_OS");
    const safety = getVal("safety") || 2;

if(!A || !DBL || !pdOD || !pdOS){
  document.getElementById("mbsLine").innerHTML = 
    `<div style="margin-bottom:4px;">
       <span style='color:var(--warn);'>Please key in frame details and PD.</span>
     </div>`;
  LAST_GEOM = null; LAST_MODE = null;
  document.getElementById("thicknessBars").innerHTML = "";
  document.getElementById("thickNote").textContent = "";
  return;
}


    LAST_GEOM = computeMBS(A,DBL,pdOD,pdOS,safety); // {semiOD, semiOS, MBS}
    LAST_MODE = "frame";
    document.getElementById("mbsLine").innerHTML = `<div style="margin-bottom:4px;">Minimum Lens Size <strong> ${LAST_GEOM.MBS.toFixed(0)} mm</strong> diameter</div>`;
    renderBars(rx, LAST_GEOM, "frame");
  };

// Calculate by Length ‚Äî thickness only
document.getElementById("btnLength").onclick = () => {
  const rx = parseRx();
  const len = getVal("lengthInput") || 30;
  LAST_GEOM = { semiOD: len, semiOS: len, MBS: 2 * len };
  LAST_MODE = "length";

  // Bold the diameter + margin-bottom
  document.getElementById("mbsLine").innerHTML =
    `<div style="margin-bottom:4px;">Minimum Lens Size <strong>${len * 2} mm</strong> diameter</div>`;

  renderBars(rx, LAST_GEOM, "length", len);
};


  // Fetch Lenses ‚Äî uses LAST_GEOM + filters
  document.getElementById("btnFetch").onclick=()=>{
    const rx = parseRx();
    buildResults(LAST_GEOM, rx);
  };
});

// Clear all filter checkboxes (does not auto-fetch)
document.getElementById("btnClearFilters").onclick = () => {
  document.querySelectorAll('.fl-appear, .fl-index, .fl-func')
    .forEach(cb => cb.checked = false);

  // Optional: also clear the table message so it's obvious filters are cleared
  // const body = document.getElementById("resultsBody");
  // body.innerHTML = `<tr><td colspan="6" class="muted">Filters cleared. Click ‚ÄúSearch Lenses‚Äù.</td></tr>`;
};

function fmtRM(n){
  if (!n || isNaN(n)) return "‚Äî";
  return Number(n).toLocaleString("en-MY"); 
}



</script>



















<script>
function bumpSph(id, amount){
  const el = document.getElementById(id);
  if(!el) return;

  let v = parseToNumber(el.value || "0");

  // ADD or SUBTRACT
  v = v + amount;

  // Snap to 0.25
  v = round025number(v);

  // Keep + sign
  el.value = formatSigned025(v);
}

function bumpSphOU(amount){
  bumpSph("sphOD", amount);
  bumpSph("sphOS", amount);
}

</script>











</body>
</html>
